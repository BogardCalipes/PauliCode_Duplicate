{% load static %}
{% include "partials/header.html" %}

<body class="g-sidenav-show text-white" style="background-color: #1E2835;">
  <div class="min-height-300 position-absolute w-100"></div>
  {% include "partials/sidebar.html" %}

  <main class="main-content position-relative border-radius-lg p-4">

    <!-- CLASS HEADER -->
    <div class="card bg-dark p-4 border-0 shadow-sm rounded-4" style="margin-top: -5px; margin-bottom: 20px;">
      <div class="d-flex justify-content-between align-items-start flex-wrap mb-3">
        <div class="flex-grow-1">
          <h3 class="fw-bold text-white mb-2">{{ class.title }}</h3>
          <p class="text-muted small mb-0">{{ class.description }}</p>
        </div>

        <div class="d-flex align-items-center mt-2 mt-md-0">
          <a href="#" class="btn btn-outline-success fw-bold me-2 align-items-center"
             data-bs-toggle="modal" data-bs-target="#addProblemModal">
            <img src="{% static 'img/plusIcon.png' %}" alt="add" style="width: 16px; height: 16px;" class="me-2">
            Add Problem
          </a>

          <a href="{% url 'delete_class' class.class_id %}"
             class="btn btn-outline-danger fw-bold align-items-center"
             onclick="return confirm('Are you sure you want to delete this class?');">
            <img src="{% static 'img/deleteIcon.png' %}" alt="delete" style="width: 18px; height: 18px;" class="me-2">
            Delete Class
          </a>
        </div>
      </div>

      <div class="mt-3">
        <span class="badge bg-success px-3 py-2">{{ class.class_code }}</span>
      </div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <div class="row g-4">

      <!-- LEFT COLUMN (Problems Section) -->
      <div class="col-lg-8">
        <div class="card bg-dark border-0 shadow-sm text-white rounded-4 p-3">

          <!-- Search and Filter -->
          <form method="GET"
                class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3"
                style="margin-top: -10px;">
            
            <!-- Title -->
            <h5 class="fw-bold text-white mb-0 d-flex align-items-center flex-shrink-0">
              <img src="{% static 'img/problemsIcon.png' %}" alt="Problems Icon" width="25" height="25" class="me-2">
              Problems
            </h5>

            <!-- Search -->
            <div class="flex-grow-1 d-flex justify-content-center">
              <input type="text" name="q" value="{{ query }}"
                     class="form-control form-control-sm text-white border-0 shadow-sm"
                     placeholder="Search problems..."
                     style="max-width: 350px; background-color: rgb(37,36,36);">
            </div>

            <!-- Filters -->
            <div class="d-flex flex-wrap justify-content-center align-items-center gap-2">
              <span class="text-white fw-semibold">Quick Filter:</span>
              <button type="submit" name="filter" value="Assignment"
                      class="btn btn-warning btn-sm fw-bold px-3 my-3 {% if filter_type == 'Assignment' %}active{% endif %}">
                Assignments
              </button>
              <button type="submit" name="filter" value="Quiz"
                      class="btn btn-success btn-sm fw-bold px-3 my-3 {% if filter_type == 'Quiz' %}active{% endif %}">
                Quizzes
              </button>
            </div>
          </form>

          <!-- Problems List -->
          {% if problems %}
          <div class="row g-3">
            {% for problem in problems %}
            <div class="col-md-6">
              <div class="card bg-transparent text-white border 
                          {% if problem.problem_type == 'Quiz' %}border-success{% else %}border-warning{% endif %}
                          rounded-3 p-3 shadow-sm h-100 problem-card"
                   data-problem-id="{{ problem.problem_id }}"
                   style="cursor: pointer;">
                <div class="d-flex justify-content-between align-items-start">
                  <h6 class="fw-bold mb-2 text-white">{{ problem.problem_title }}</h6>
                  <span class="badge 
                    {% if problem.problem_type == 'Quiz' %}bg-success{% else %}bg-warning text-dark{% endif %}">
                    Due: {{ problem.due_date|date:"M d, Y H:i" }}
                  </span>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="p-3 rounded-3 text-center text-muted"
               style="min-height: 316px; background-color: rgb(37,36,36);">
            <p>No problems yet. Click <b>Add Problem</b> to create one.</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- RIGHT COLUMN (Students Section) -->
      <div class="col-lg-4">
        <div class="card bg-dark border-0 shadow-sm text-white rounded-4 p-3">
          <h5 class="fw-bold text-white" style = "margin-bottom: -5px;">Students</h5>

<!-- Student Search Form -->

<form method="GET" class="">
  <div class="d-flex align-items-center gap-2" style="width: 100%;">
    <input type="text" name="student_search" value="{{ student_query }}"
           class="form-control form-control-sm text-white border-0 shadow-sm flex-grow-1"
           placeholder="Search students..."
           style="background-color: rgb(37,36,36); height: 36px; font-size: 14px; min-width: 200px; max-width: 400px;">
    <button class="btn btn-success fw-bold btn-sm"
            type="submit"
            style="height: 36px; padding: 16 px 16px; font-size: 13px; border-radius: 6px; margin-top: 13px;">
      Search
    </button>
  </div>
</form>



<!-- Student List -->
<div class="p-3 rounded-3 text-start text-white"
     style="min-height: 300px; background-color: rgb(37,36,36); overflow-y: auto; max-height: 350px;">
  {% if students %}
    <ul class="list-group list-group-flush">
      {% for enrollment in students %}
        <li class="list-group-item bg-transparent text-white d-flex align-items-center justify-content-between border-0 py-2">
          <div class="d-flex align-items-center">
            {% if enrollment.student_id.user_image %}
              <img src="{{ enrollment.student_id.user_image.url }}" alt="student" 
                   class="rounded-circle me-2" width="35" height="35">
            {% else %}
              <img src="{% static 'img/default_user.png' %}" alt="student" 
                   class="rounded-circle me-2" width="35" height="35">
            {% endif %}
            <span>{{ enrollment.student_id.first_name }} {{ enrollment.student_id.last_name }}</span>
          </div>
          <span class="badge bg-secondary small">{{ enrollment.student_id.school_id }}</span>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="text-center text-muted py-4">
      <p>No students enrolled yet.</p>
    </div>
  {% endif %}
</div>

        </div>
      </div>
    </div>

    <!-- CREATE NEW PROBLEM MODAL -->
    {% include "partials/add_problem_modal.html" %}

    <!-- EDIT PROBLEM MODAL -->
    <div class="modal fade" id="problemDetailsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content text-white" style="background-color: #1E2835; border-radius: 15px;">
          <form method="POST" id="editProblemForm" action="">
            {% csrf_token %}
            
            <!-- Header -->
            <div class="modal-header border-0 pb-0">
              <h4 class="fw-bold text-success">Edit Problem</h4>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <!-- Body -->
            <div class="modal-body px-4 pb-1">
              <input type="hidden" id="problem_id" name="problem_id">

              <div class="row g-3">
                
                <!-- Left -->
                <div class="col-md-6">
                  <label class="fw-semibold mb-1">Title</label>
                  <input type="text" id="problem_title" name="problem_title"
                         class="form-control text-white"
                         style="background-color: #101826; border: 1px solid #2b3a55;">

                  <div class="row g-2 mt-3">
                    <div class="col-6">
                      <label class="fw-semibold mb-1">Score</label>
                      <input type="number" id="total_score" name="total_score"
                             class="form-control text-white"
                             style="background-color: #101826; border: 1px solid #2b3a55;">
                    </div>
                    <div class="col-6">
                      <label class="fw-semibold mb-1">Due Date</label>
                      <input type="datetime-local" id="due_date" name="due_date"
                             class="form-control text-white"
                             style="background-color: #101826; border: 1px solid #2b3a55;">
                    </div>
                  </div>

                  <div class="row g-2 mt-3">
                    <div class="col-6">
                      <label class="fw-semibold mb-1">Time Limit</label>
                      <input type="number" id="time_limit" name="time_limit"
                             class="form-control text-white"
                             style="background-color: #101826; border: 1px solid #2b3a55;">
                    </div>
                    <div class="col-6">
                      <label class="fw-semibold mb-1">Type</label>
                      <select id="problem_type" name="problem_type"
                              class="form-select text-white"
                              style="background-color: #101826; border: 1px solid #2b3a55;">
                        <option value="Assignment">Assignment</option>
                        <option value="Quiz">Quiz</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Right -->
                <div class="col-md-6">
                  <label class="fw-semibold mb-1">Instruction</label>
                  <textarea id="problem_description" name="problem_description" rows="5"
                            class="form-control text-white"
                            style="background-color: #101826; border: 1px solid #2b3a55;"></textarea>

                  <label class="fw-semibold mt-3 mb-2">Test Cases</label>
                  <div class="row g-2">
                    {% for i in "123" %}
                    <div class="col-4">
                      <textarea id="input{{ i }}" name="input{{ i }}" rows="2"
                                class="form-control text-white small-placeholder mb-1"
                                placeholder="Input {{ i }}"
                                style="background-color: #101826; border: 1px solid #2b3a55;"></textarea>
                      <textarea id="output{{ i }}" name="output{{ i }}" rows="2"
                                class="form-control text-white small-placeholder"
                                placeholder="Output {{ i }}"
                                style="background-color: #101826; border: 1px solid #2b3a55;"></textarea>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer border-0 d-flex justify-content-between pt-0">
              <button type="button" class="btn btn-outline-light px-4" data-bs-dismiss="modal">Cancel</button>
              <div>
                <button type="submit" class="btn btn-info fw-bold px-4 me-2">Save Changes</button>
                <a href="#" id="deleteProblemBtn" class="btn btn-danger fw-bold px-4"
                   onclick="return confirm('Are you sure you want to delete this problem?');">Delete</a>
              </div>
            </div>

          </form>
        </div>
      </div>
    </div>

  </main>

  {% include "partials/footer.html" %}
  {% include "partials/scripts.html" %}

  <!-- JavaScript: Load problem details dynamically -->
  <script>
    document.querySelectorAll('.problem-card').forEach(card => {
      card.addEventListener('click', function() {
        const problemId = this.dataset.problemId;

        fetch(`/problem/${problemId}/details/`)
          .then(res => res.json())
          .then(data => {
            const form = document.getElementById('editProblemForm');
            form.reset();
            form.action = `/problem/${problemId}/edit/`;

            document.getElementById('problem_id').value = data.problem_id;
            document.getElementById('problem_title').value = data.title;
            document.getElementById('problem_description').value = data.description;
            document.getElementById('problem_type').value = data.type;
            document.getElementById('total_score').value = data.score;
            document.getElementById('time_limit').value = data.time_limit;
            document.getElementById('due_date').value = data.due_date;

            for (let i = 1; i <= 3; i++) {
              document.getElementById(`input${i}`).value = "";
              document.getElementById(`output${i}`).value = "";
            }

            data.test_cases.forEach((tc, index) => {
              const i = index + 1;
              document.getElementById(`input${i}`).value = tc.input;
              document.getElementById(`output${i}`).value = tc.output;
            });

            document.getElementById('deleteProblemBtn').href = `/problem/${problemId}/delete/`;

            const modal = new bootstrap.Modal(document.getElementById('problemDetailsModal'));
            modal.show();
          });
      });
    });
  </script>

  <style>
    .btn-success { background-color: #00C98D; border: none; }
    .btn-success:hover { background-color: #00b07d; }
    .btn-danger { background-color: #ff4b5c; border: none; }
    .btn-danger:hover { background-color: #e63b4b; }
    .card { background-color: #2C3648 !important; }
    .small-placeholder::placeholder { font-size: 0.65rem; color: #b0b0b0; }
  </style>
</body>
</html>
