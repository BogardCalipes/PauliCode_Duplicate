{% load static %}

<!-- Core JS -->
<script src="{% static 'js/core/popper.min.js' %}"></script>
<script src="{% static 'js/core/bootstrap.min.js' %}"></script>
<script src="{% static 'js/plugins/perfect-scrollbar.min.js' %}"></script>
<script src="{% static 'js/plugins/smooth-scrollbar.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ChartJS -->
<script src="{% static 'js/plugins/chartjs.min.js' %}"></script>

<!-- Example Chart Initialization -->
<script>
  var ctx1 = document.getElementById("chart-line").getContext("2d");

  var gradientStroke1 = ctx1.createLinearGradient(0, 230, 0, 50);
  gradientStroke1.addColorStop(1, 'rgba(94, 114, 228, 0.2)');
  gradientStroke1.addColorStop(0.2, 'rgba(94, 114, 228, 0.0)');
  gradientStroke1.addColorStop(0, 'rgba(94, 114, 228, 0)');

  new Chart(ctx1, {
    type: "line",
    data: {
      labels: ["Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
      datasets: [{
        label: "Mobile apps",
        tension: 0.4,
        borderWidth: 0,
        pointRadius: 0,
        borderColor: "#5e72e4",
        backgroundColor: gradientStroke1,
        borderWidth: 3,
        fill: true,
        data: [50, 40, 300, 220, 500, 250, 400, 230, 500],
        maxBarThickness: 6
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
      },
      interaction: { intersect: false, mode: 'index' },
      scales: {
        y: {
          grid: {
            drawBorder: false,
            display: true,
            drawOnChartArea: true,
            drawTicks: false,
            borderDash: [5, 5]
          },
          ticks: {
            display: true,
            padding: 10,
            color: '#fbfbfb',
            font: { size: 11, family: "Open Sans", style: 'normal', lineHeight: 2 }
          }
        },
        x: {
          grid: {
            drawBorder: false,
            display: false,
            drawOnChartArea: false,
            drawTicks: false,
            borderDash: [5, 5]
          },
          ticks: {
            display: true,
            color: '#ccc',
            padding: 20,
            font: { size: 11, family: "Open Sans", style: 'normal', lineHeight: 2 }
          }
        },
      },
    },
  });
</script>

<!-- Scrollbar script -->
<script>
  var win = navigator.platform.indexOf('Win') > -1;
  if (win && document.querySelector('#sidenav-scrollbar')) {
    var options = { damping: '0.5' }
    Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
  }
</script>

<!-- GitHub Buttons -->
<script async defer src="https://buttons.github.io/buttons.js"></script>

<!-- Argon Dashboard Control Center -->
<script src="{% static 'js/argon-dashboard.min.js' %}"></script>


<!--student_class_details-->

<!-- SEARCH & FILTER JS -->
 <script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('form');
    const searchInput = form.querySelector('input[name="q"]');
    const filterButtons = document.querySelectorAll('button[name="filter"]');

    filterButtons.forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();

        const selectedFilter = btn.value;
        const searchValue = searchInput.value.trim();

        const url = new URL(window.location.href);

        // If user clicks the same filter again, remove it (toggle off)
        if (url.searchParams.get('filter') === selectedFilter) {
          url.searchParams.delete('filter');
        } else {
          url.searchParams.set('filter', selectedFilter);
        }

        // Keep the search query if it exists
        if (searchValue) {
          url.searchParams.set('q', searchValue);
        } else {
          url.searchParams.delete('q');
        }

        window.location.href = url.toString();
      });
    });

    // Clear search query dynamically when the input is cleared
    searchInput.addEventListener('input', () => {
      if (searchInput.value.trim() === '') {
        const url = new URL(window.location.href);
        url.searchParams.delete('q');
        window.location.href = url.toString();
      }
    });
  });
</script>


 <script>
document.querySelectorAll('.problem-card').forEach(card => {
  card.addEventListener('click', function() {
    const problemId = this.dataset.problemId;
    if (!problemId) return;

    fetch(`/problem/${problemId}/details/`)
      .then(res => res.json())
      .then(data => {
        // Fill in modal data
        document.getElementById('problem_title').textContent = data.title;
        document.getElementById('problem_description').textContent = data.description;
        document.getElementById('problem_type').textContent = data.type;
        document.getElementById('total_score').textContent = data.score;
        document.getElementById('time_limit').textContent = data.time_limit;
        document.getElementById('due_date').textContent = "Due: " + data.due_date;

                // Populate test cases
        const container = document.getElementById('test_cases_container');
        container.innerHTML = '';

       data.test_cases.forEach((tc, index) => {
            const col = document.createElement('div');
            col.className = 'col-12';

            const total = data.test_cases.length;
            const testCaseNumber = index + 1;
            let hideIndex = total; // Hide the last test case, depending on total count

            if (testCaseNumber === hideIndex) {
              // Hide this test case
              col.innerHTML = `
                <div class="p-3 mb-3 rounded text-center" style="background:#1e2b4d; border:1px dashed #3b4b6b;">
                  <span class="badge bg-secondary px-3 py-2">Test Case ${testCaseNumber} Hidden</span>
                </div>
              `;
            } else {
              // Show normal test case
              col.innerHTML = `
                <div class="p-2 mb-2 rounded" style="background:#121f3d; border:1px solid #2b3a55;">
                  <strong>Input ${testCaseNumber}:</strong>
                  <pre style="margin:0; white-space:pre-wrap;">${tc.input}</pre>
                </div>
                <div class="p-2 mb-3 rounded" style="background:#121f3d; border:1px solid #2b3a55;">
                  <strong>Output ${testCaseNumber}:</strong>
                  <pre style="margin:0; white-space:pre-wrap;">${tc.output}</pre>
                </div>
              `;
            }

            container.appendChild(col);
          });



        // Get reference to Answer button
        const answerBtn = document.getElementById('answerButton');

        // ‚úÖ Disable button if problem already answered
        if (data.answered === true) {
          answerBtn.disabled = true;
          answerBtn.textContent = "Answered";
          answerBtn.classList.remove("btn-success");
          answerBtn.classList.add("btn-secondary");
        } else {
          answerBtn.disabled = false;
          answerBtn.textContent = "Answer";
          answerBtn.classList.add("btn-success");
          answerBtn.classList.remove("btn-secondary");
        }

        // Set Answer button link dynamically
        answerBtn.onclick = () => {
          if (!data.answered) {
            window.location.href = `/playground/${problemId}/`;
          }
        };

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('problemDetailsModal'));
        modal.show();
      })
      .catch(err => console.error('Error fetching problem details:', err));
  });
});
</script>

<!--Student Playground-->

<!-- Ace Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ext-language_tools.js"></script>
<script>
let editor = ace.edit("codeEditor");
editor.setTheme("ace/theme/dracula");
editor.session.setMode("ace/mode/python");
editor.setOptions({
  enableBasicAutocompletion: true,
  enableLiveAutocompletion: true,
  fontSize: "14px",
  showPrintMargin: false,
  highlightActiveLine: true,
  tabSize: 4,
  useSoftTabs: true
});

const languageModes = {
  python: "ace/mode/python",
  c: "ace/mode/c_cpp",
  cpp: "ace/mode/c_cpp",
  java: "ace/mode/java"
};
document.getElementById("language").addEventListener("change", e => {
  editor.session.setMode(languageModes[e.target.value]);
});

function getCode() { return editor.getValue(); }

function getProblemTestCount() {
  const meta = document.getElementById('problemMeta');
  return parseInt(meta?.dataset?.testCount || '0', 10);
}
function getProblemTotalScore() {
  const meta = document.getElementById('problemMeta');
  return parseInt(meta?.dataset?.totalScore || '0', 10);
}

function animateTestUpdates(testResults) {
  const totalPoints = getProblemTestCount() * 10;
  let runningScore = 0;

  testResults.forEach((res, idx) => {
    const delay = idx * 350;
    setTimeout(() => {
      const id = `tcStatus${idx+1}`;
      const el = document.getElementById(id);
      if (!el) return;
      if (res === true) {
        el.className = 'badge bg-success';
        el.textContent = `PASSED`;
        runningScore += 10;
      } else if (res === false) {
        el.className = 'badge bg-danger';
        el.textContent = `FAILED`;
      } else {
        el.className = 'badge bg-secondary';
        el.textContent = `Hidden`;
      }
      document.getElementById('studentScoreValue').textContent = runningScore;
      document.getElementById('studentScoreTotal').textContent = totalPoints;
    }, delay);
  });
}

function parseResultSummary(resultSummary) {
  const lines = (resultSummary || '').split('\n');
  const testCount = getProblemTestCount();
  const results = new Array(testCount).fill(null);
  lines.forEach(line => {
    const m = line.match(/Test\s*(\d+):\s*(Passed|Failed|Error)/i);
    if (m) {
      const idx = parseInt(m[1], 10) - 1;
      const status = m[2].toLowerCase();
      if (status === 'passed') results[idx] = true;
      else results[idx] = false;
    }
  });
  return results;
}

async function runCode(checkMode=false) {
  const modalOutput = checkMode ? document.getElementById('checkResult') : document.getElementById('terminalOutput');
  const checkLoading = document.getElementById('checkLoading');

  if (checkMode) {
    modalOutput.textContent = "";
    checkLoading.style.display = "flex";
  } else {
    modalOutput.textContent = "Running...";
  }

  try {
    const code = getCode();
    const lang = document.getElementById('language').value;
    const problemId = "{{ problem.problem_id }}";
    const stdinData = document.getElementById('userInput').value;
    const url = "{% url 'run_playground_code' %}";

    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        code: code,
        language: lang,
        check_mode: checkMode,
        problem_id: problemId,
        stdin: stdinData
      })
    });

    const data = await response.json();

    if (checkMode) {
      checkLoading.style.display = "none";
      if (data.error) { modalOutput.textContent = "‚ö†Ô∏è " + data.error; return; }

      const testResults = parseResultSummary(data.result_summary);
      animateTestUpdates(testResults);
      modalOutput.innerHTML = `<pre style="color:#28a745;">${data.result_summary}</pre>`;
      document.getElementById('submitBtn').style.display = 'inline-block';
    } else {
      modalOutput.textContent = data.output || "No output.";
    }

  } catch (err) {
    if (checkMode) checkLoading.style.display = "none";
    modalOutput.textContent = "‚ö†Ô∏è Failed to connect to server: " + err.message;
    console.error(err);
  }
}

let hasSubmitted = false;

// Named beforeunload handler so we can remove it when needed
function beforeUnloadHandler(e) {
  if (!hasSubmitted) {
    e.preventDefault();
    e.returnValue = "Are you sure you want to leave? Your work will be submitted automatically.";
    autoSubmitOnTimeout();
    hasSubmitted = true;
  }
}
window.addEventListener("beforeunload", beforeUnloadHandler);

async function submitCode() {
  const checkResultDiv = document.getElementById('checkResult');
  const checkLoading = document.getElementById('checkLoading');

  checkResultDiv.textContent = "";
  checkLoading.style.display = "flex";

  try {
    const code = getCode();
    const problemId = "{{ problem.problem_id }}";
    const lang = document.getElementById('language').value;

    const response = await fetch(`/submit_problem/${problemId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        problem_id: problemId,
        code: code,
        language: lang
      })
    });

    const data = await response.json();
    checkLoading.style.display = "none";

    if (data.success) {
      const testResults = parseResultSummary(data.result_summary);
      animateTestUpdates(testResults);

      const finalScore = data.score ?? (testResults.filter(Boolean).length * 10);
      document.getElementById('studentScoreValue').textContent = finalScore;
      document.getElementById('studentScoreTotal').textContent = (getProblemTestCount() * 10);

      checkResultDiv.innerHTML = `<pre style="color:#28a745;">${data.result_summary}</pre>`;

      // ‚úÖ Disable unload prompt after manual submit
      hasSubmitted = true;
      window.removeEventListener("beforeunload", beforeUnloadHandler);

      localStorage.removeItem(`problem_timer_{{ problem.problem_id }}`);
      setTimeout(() => {
        window.location.href = data.redirect_url || "{% url 'StudentClass' %}";
      }, 1500);
    } else {
      checkResultDiv.textContent = "‚ö†Ô∏è " + (data.message || "Submission failed.");
    }
  } catch (error) {
    checkLoading.style.display = "none";
    checkResultDiv.textContent = "‚ö†Ô∏è Submission failed: " + error.message;
    console.error(error);
  }
}

// =============================
//  COUNTDOWN TIMER (Persistent)
// =============================
(function startPersistentCountdown() {
  const timerMeta = document.getElementById('problemTimer');
  if (!timerMeta) return;

  const problemId = "{{ problem.problem_id }}";
  const storageKey = `problem_timer_${problemId}`;
  const timeLimitMinutes = parseInt(timerMeta.dataset.timelimit || '0', 10);
  if (isNaN(timeLimitMinutes) || timeLimitMinutes <= 0) return;

  const timerDisplay = document.getElementById('timerDisplay');
  let deadline;

  const savedData = localStorage.getItem(storageKey);
  if (savedData) {
    const parsed = JSON.parse(savedData);
    deadline = new Date(parsed.deadline);
  } else {
    const now = new Date();
    deadline = new Date(now.getTime() + timeLimitMinutes * 60 * 1000);
    localStorage.setItem(storageKey, JSON.stringify({ deadline: deadline.toISOString() }));
  }

  const tick = setInterval(() => {
    const now = new Date();
    const remaining = Math.floor((deadline - now) / 1000);

    if (remaining <= 0) {
      clearInterval(tick);
      timerDisplay.textContent = "‚è±Ô∏è Time‚Äôs up!";
      timerDisplay.classList.remove('text-warning');
      timerDisplay.classList.add('text-danger');
      localStorage.removeItem(storageKey);
      alert("Time is up! Your code will be submitted automatically.");
      autoSubmitOnTimeout();
      return;
    }

    const m = Math.floor(remaining / 60);
    const s = remaining % 60;
    timerDisplay.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  }, 1000);
})();

// =============================
// AUTO SUBMIT ON TIMEOUT
// =============================
async function autoSubmitOnTimeout() {
  const checkResultDiv = document.getElementById('checkResult');
  const checkLoading = document.getElementById('checkLoading');

  checkResultDiv.textContent = "";
  checkLoading.style.display = "flex";

  // Determine safe redirect URLs
  const studentClassUrl = "{% url 'StudentClass' %}";
  const studentClassDetailsUrl = "{% if problem and problem.class_id %}{% url 'student_class_details' problem.class_id.class_id %}{% else %}" + studentClassUrl + "{% endif %}";

  try {
    const code = getCode();
    const problemId = "{{ problem.problem_id|default:'' }}"; // fallback to empty string if undefined
    const lang = document.getElementById('language')?.value || 'python';

    // Only send request if problemId exists
    if (!problemId) {
      checkLoading.style.display = "none";
      alert("‚ö†Ô∏è No problem selected. Redirecting...");
      window.location.href = studentClassUrl;
      return;
    }

    const response = await fetch(`/submit_problem/${problemId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        problem_id: problemId,
        code: code,
        language: lang
      })
    });

    const data = await response.json();
    checkLoading.style.display = "none";
    localStorage.removeItem(`problem_timer_${problemId}`);

    // ‚úÖ Disable unload handler after auto-submit
    hasSubmitted = true;
    window.removeEventListener("beforeunload", beforeUnloadHandler);

    if (data.success) {
      alert("‚úÖ Time‚Äôs up! Your code has been submitted automatically.");
      window.location.href = data.redirect_url || studentClassDetailsUrl;
    } else {
      alert("‚ö†Ô∏è Auto-submit failed. Redirecting...");
      window.location.href = studentClassDetailsUrl;
    }
  } catch (error) {
    checkLoading.style.display = "none";
    console.error(error);
    alert("‚ö†Ô∏è Error during auto submission. Redirecting...");
    window.location.href = studentClassDetailsUrl;
  }
}

// =============================
//  PREVENT BACK NAVIGATION
// =============================
(function preventBackNavigation() {
  history.pushState(null, null, location.href);
  window.onpopstate = function () {
    history.pushState(null, null, location.href);
    alert("üö´ You cannot go back during the problem session.");
  };
})();

// =============================
//  DETECT TAB SWITCH OR PAGE CLOSE
// =============================
window.addEventListener("blur", () => {
  if (!hasSubmitted) {
    alert("üö´ You switched tabs! Your session will end for security.");
    autoSubmitOnTimeout();
    hasSubmitted = true;
  }
});
</script>




<!--base.html-->

