{% load static %}
{% include "partials/header.html" %}

<body class="g-sidenav-show text-white">
{% include "partials/sidebar.html" %}

<style>
  body { background-color: #111827 !important; }
  .card { background-color: #1f2937; border: none; color: white; border-radius: 1rem; }
  h5, h6, p, th, td { color: white; }
  .btn-custom { margin-right: 10px; }
  .btn-delete { background-color: #dc3545; color: white; }
  
  .table { color: white; }
  .table thead th { color: #9ca3af; }
</style>

<main class="main-content position-relative border-radius-lg">
  <div class="container-fluid py-5">

    <!-- HEADER -->
    <div class="card bg-success text-white border-0 mb-4 rounded-4 shadow-sm">
      <div class="card-body py-4">
        <h3 class="fw-bold text-white mb-1">Class Reports</h3>
        <h6 class="text-white small">Search a class to view its problems and student results.</h6>
      </div>
    </div>
    <div class="d-flex justify-content-between align-items-start flex-wrap p-3">

    <!-- Left: Title -->
      <h4 class="fw-bold text-white mb-md-0">Class Details</h4>
    <!-- SEARCH BAR -->
    <form class="d-flex mb-4" method="GET" action="{% url 'report' %}">
    <input 
        class="form-control form-control-sm bg-dark text-white border-0 shadow-sm"
        style="width: 40vh; height: 5vh; border-radius: 0.25rem;"
        type="search" 
        name="search" 
        placeholder="Search by class title or class code" 
        aria-label="Search"
        value="{{ request.GET.search|default:'' }}">
    <button class="btn btn-outline-success btn-sm ms-2 px-3 align-items-center" type="submit">
        <i class="fa fa-search me-1"></i> Search
    </button>
    </form>

    </div>


    {% if selected_class %}
    <!-- CLASS DETAILS -->
    <div class="card p-4 mb-4 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h4 class="fw-bold text-white">{{ selected_class.title }}</h4>
          <p class="text-muted mb-1">Class Code: {{ selected_class.class_code }}</p>
          <p class="mb-0 text-dark">{{ selected_class.description }}</p>
        </div>
        <div>
          <a href="{% url 'delete_class' selected_class.class_id %}" class="btn btn-delete">Delete Class</a>
        </div>
      </div>
    </div>

    <!-- PROBLEMS SECTION -->
    <div class="card p-4 mb-4 shadow-sm">
      <h5 class="fw-bold mb-3">Problems</h5>
      <table class="table table-hover">
        <thead class = "text-center align-items-center">
          <tr>
            <th>Problem ID</th>
            <th>Title</th>
            <th>Time Limit</th>
            <th>Due Date</th>
          </tr>
        </thead>
        <tbody class = "text-center align-items-center">
          {% for problem in problems %}
            {% if problem.class_id == selected_class %}
            <tr>
              <td>{{ problem.problem_id }}</td>
              <td>{{ problem.problem_title }}</td>
              <td>{{ problem.time_limit|default:"-" }}</td>
              <td>{{ problem.due_date|date:"Y-m-d H:i" }}</td>
            </tr>
            {% endif %}
          {% empty %}
            <tr><td colspan="4" class="text-center text-muted">No problems found for this class.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- STUDENTS ENROLLED -->
    <div class="card p-4 mb-4 shadow-sm">
      <h5 class="fw-bold mb-3">Students Enrolled</h5>
      <table class="table table-hover">
        <thead class = "text-center align-items-center">
          <tr>
            <th>Name</th>
            <th>School ID</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody class = "text-center align-items-center">
          {% for student in enrolled_students %}
          <tr>
            <td>{{ student.first_name }} {{ student.last_name }}</td>
            <td>{{ student.school_id }}</td>
            <td>
            <a href="{% url 'delete_student' student.school_id %}" class="btn btn-sm btn-delete">Delete</a>

            </td>
          </tr>
          {% empty %}
          <tr><td colspan="3" class="text-center text-muted">No students enrolled in this class.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- STUDENT RESULTS -->
    <div class="card p-4 shadow-sm mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold">Student Results</h5>
        <div>
          <button class="btn btn-primary btn-sm btn-custom" onclick="printTable('studentResultsTable')">Print</button>
          <button class="btn btn-success btn-sm btn-custom" onclick="downloadCSV('studentResultsTable', 'student_results.csv')">Save CSV</button>
        </div>
      </div>

      <table id="studentResultsTable" class="table table-hover">
        <thead class = "text-center align-items-center">
          <tr>
            <th>Student Name</th>
            <th>School ID</th>
            <th>Problem</th>
            <th>Score</th>
           
            <th>Code</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody class = "text-center align-items-center">
          {% for submission in submissions %}
            {% if submission.problem_id.class_id == selected_class %}
            <tr>
              <td>{{ submission.student_id.first_name }} {{ submission.student_id.last_name }}</td>
              <td>{{ submission.student_id.school_id }}</td>
              <td>{{ submission.problem_id.problem_title }}</td>
              <td>{{ submission.score|default:"-" }}</td>
              <td><pre style="color:white; font-size:0.8em;">{{ submission.code|truncatechars:80 }}</pre></td>
              <td>
                <a href="{% url 'delete_submission' submission.submission_id %}" class="btn btn-sm btn-delete">Delete</a>
              </td>
            </tr>
            {% endif %}
          {% empty %}
            <tr><td colspan="7" class="text-center text-muted">No student results found for this class.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% elif request.GET.search %}
      <div class="text-center text-muted">No class found matching your search.</div>
    {% endif %}

    {% include "partials/footer.html" %}
  </div>
</main>

<script>
  function downloadCSV(tableId, filename) {
    let csv = [];
    const rows = document.querySelectorAll(`#${tableId} tr`);
    rows.forEach(row => {
      const cols = row.querySelectorAll("th, td:not(:last-child)");
      let rowData = [];
      cols.forEach(col => rowData.push(col.innerText.replace(/\n/g, " ")));
      csv.push(rowData.join(","));
    });
    const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
    const downloadLink = document.createElement("a");
    downloadLink.download = filename;
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = "none";
    document.body.appendChild(downloadLink);
    downloadLink.click();
  }

  function printTable(tableId) {
    const printContents = document.getElementById(tableId).outerHTML;
    const originalContents = document.body.innerHTML;
    document.body.innerHTML = printContents;
    window.print();
    document.body.innerHTML = originalContents;
    location.reload();
  }
</script>

{% include "partials/scripts.html" %}
</body>
</html>
